{% extends 'layout.html' %} {% block title %}Kết quả Quét #{{ scan.id }}{%
endblock %} {% block content %}
<div class="bg-white p-6 rounded-lg shadow-lg mb-8">
  <h1 class="text-3xl font-bold text-gray-800">Báo cáo Quét #{{ scan.id }}</h1>
  <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-600">
    <div>
      <strong>URL Mục tiêu:</strong>
      <span class="font-mono text-sm break-all">{{ scan.target_url }}</span>
    </div>
    <div>
      <strong>Thời gian:</strong> {{
      scan.created_at.strftime('%Y-%m-%d%H:%M:%S') }}
    </div>
    <div id="scan-status-details">
      <strong>Trạng thái:</strong>
      <span
        class="px-2 py-1 font-semibold leading-tight rounded-full"
        data-status="{{ scan.status }}"
        >{{ scan.status }}</span
      >
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
  <div class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Phân loại Lỗ hổng</h2>
    <canvas
      id="vulnTypeChart"
      data-url="{{ url_for('vulnerability_types_data', scan_id=scan.id) }}"
    ></canvas>
  </div>
  <div class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Thống kê</h2>
    <div class="space-y-4">
      <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
        <span class="font-semibold text-gray-700">Tổng số lỗ hổng</span>
        <span class="text-2xl font-bold text-red-500"
          >{{ vulnerabilities|length }}</span
        >
      </div>
    </div>
  </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-lg">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">
    Danh sách Lỗ hổng Chi tiết
  </h2>
  <div class="space-y-6">
    {% for vuln in vulnerabilities %}
    <div
      class="border rounded-lg overflow-hidden transition-shadow duration-300 hover:shadow-xl"
    >
      <div
        class="bg-gray-100 p-4 flex justify-between items-center border-b cursor-pointer"
        onclick="toggleDetails('vuln-body-{{ vuln.id }}')"
      >
        <div>
          <span class="font-bold text-lg text-red-600"
            >{{ vuln.vuln_type }}</span
          >
          <span class="text-gray-600">({{ vuln.method }})</span>
        </div>
        <div class="text-right">
          <span class="font-semibold">Độ tin cậy AI:</span>
          <span class="text-blue-600 font-bold"
            >{{ "%.0f"|format((vuln.ai_confidence or 0) * 100) }}%</span
          >
        </div>
      </div>
      <div id="vuln-body-{{ vuln.id }}" class="p-4 space-y-4">
        <div>
          <strong class="text-gray-700">URL Bị ảnh hưởng:</strong>
          <p class="font-mono text-sm break-all bg-gray-50 p-2 rounded mt-1">
            {{ vuln.url }}
          </p>
        </div>
        <div>
          <strong class="text-gray-700">Payload được sử dụng:</strong>
          <p class="font-mono text-sm break-all bg-gray-50 p-2 rounded mt-1">
            {{ vuln.payload }}
          </p>
        </div>
        <div>
          <strong class="text-gray-700">Bằng chứng (Evidence):</strong>
          <p class="italic text-gray-800 bg-gray-50 p-2 rounded mt-1">
            {{ vuln.evidence }}
          </p>
        </div>
        <div>
          <strong class="text-gray-700">Gợi ý Khắc phục:</strong>
          <p
            class="text-sm text-gray-800 bg-green-50 p-3 rounded border-l-4 border-green-500 mt-1"
          >
            {{ get_remediation_advice(vuln.vuln_type) }}
          </p>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center py-8">
      <p class="text-gray-500 text-lg">
        Tuyệt vời! Không tìm thấy lỗ hổng nào trong phiên quét này.
      </p>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  function toggleDetails(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
      element.classList.toggle("hidden");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Cập nhật màu trạng thái (giữ nguyên logic)
    document.querySelectorAll("[data-status]").forEach((span) => {
      const status = span.dataset.status.toUpperCase();
      span.className = "px-2 py-1 font-semibold leading-tight rounded-full"; // Reset
      if (status === "COMPLETED")
        span.classList.add("text-green-700", "bg-green-100");
      else if (status === "SCANNING" || status === "CRAWLING")
        span.classList.add("text-yellow-700", "bg-yellow-100");
      else if (status === "PENDING" || status === "INITIALIZING")
        span.classList.add("text-gray-700", "bg-gray-100");
      else if (status.startsWith("FAILED"))
        span.classList.add("text-red-700", "bg-red-100");
    });

    // Vẽ biểu đồ (giữ nguyên logic)
    const chartCanvas = document.getElementById("vulnTypeChart");
    if (chartCanvas) {
      const dataUrl = chartCanvas.dataset.url;
      const ctx = chartCanvas.getContext("2d");

      fetch(dataUrl)
        .then((response) => response.json())
        .then((data) => {
          if (data.labels && data.labels.length > 0) {
            new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: data.labels,
                datasets: [
                  {
                    label: "Số lượng",
                    data: data.counts,
                    backgroundColor: [
                      "rgba(239, 68, 68, 0.7)", // red-500
                      "rgba(249, 115, 22, 0.7)", // orange-500
                      "rgba(234, 179, 8, 0.7)", // yellow-500
                      "rgba(59, 130, 246, 0.7)", // blue-500
                      "rgba(139, 92, 246, 0.7)", // violet-500
                      "rgba(236, 72, 153, 0.7)", // pink-500
                    ],
                    borderColor: "#ffffff",
                    borderWidth: 2,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: "top",
                  },
                  title: {
                    display: false,
                  },
                },
              },
            });
          } else {
            const container = chartCanvas.parentElement;
            container.innerHTML =
              '<p class="text-center text-gray-500 py-8">Không có dữ liệu để vẽ biểu đồ.</p>';
          }
        });
    }
  });
</script>
{% endblock %}
